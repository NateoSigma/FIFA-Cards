<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Karciana RPG</title>
<style>
body {
  background: #111;
  color: white;
  font-family: Arial;
  text-align: center;
}

/* Ekrany */
.screen { display: none; }
.active { display: block; }

/* Karty */
.card {
  width: 130px;
  padding: 10px;
  margin: 10px;
  background: #222;
  border-radius: 10px;
  display: inline-block;
  border: 2px solid #666;
}
.card img {
  width: 100%;
}
.card[data-rarity="Basic"] { border-color: #444; }
.card[data-rarity="Rare"] { border-color: #00ff88; }
.card[data-rarity="Epic"] { border-color: #b300ff; }
.card[data-rarity="Legendary"] { border-color: #ffd700; }
.card[data-rarity="Mythic"] { border-color: #ff3333; }
.card[data-rarity="Eternal"] { border-color: #8b00ff; }
.card[data-rarity="Exclusive"] { border-color: orange; }

.hp-bar-bg {
  width: 100%;
  height: 12px;
  background: #444;
  border-radius: 6px;
  margin-top: 5px;
}
.hp-bar {
  height: 12px;
  background: red;
  width: 100%;
  border-radius: 6px;
}

/* Walka */
.battleArea {
  display: flex;
  justify-content: space-around;
  margin-top: 30px;
}
.hit {
  animation: hitFlash 0.2s;
}
@keyframes hitFlash {
  0% { filter: brightness(2); }
  100% { filter: brightness(1); }
}

.button {
  padding: 10px 20px;
  margin: 10px;
  cursor: pointer;
  background: #333;
  border: 2px solid white;
  border-radius: 8px;
}
</style>
</head>
<body>

<!-- âœ… EKRAN TWORZENIA POSTACI -->
<div id="createScreen" class="screen active">
  <h2>Wpisz nazwÄ™ uÅ¼ytkownika</h2>
  <input type="text" id="playerName" placeholder="Nazwa">
  <button class="button" onclick="createPlayer()">Start</button>
</div>

<!-- âœ… LOBBY -->
<div id="lobbyScreen" class="screen">
  <h2>Witaj, <span id="nameDisplay"></span>!</h2>
  <p>Coins: <span id="coinsDisplay"></span></p>

  <button class="button" onclick="goInventory()">Ekwipunek</button>
  <button class="button" onclick="enterShop()">Sklep</button>
  <button class="button" onclick="enterFusion()">âš—ï¸ Fuzje</button>
  <button class="button" onclick="enterQuests()">ğŸŸ  Questy</button>
  <button class="button" onclick="enterBattle()">âš” Pojedynek</button>
  <button class="button" onclick="enterSettings()">âš™ Ustawienia</button>
</div>

<!-- âœ… EKWIPUNEK -->
<div id="inventoryScreen" class="screen">
  <h2>Twoje karty</h2>
  <div id="inventory"></div>

  <h3>Twoja druÅ¼yna (max 3)</h3>
  <div id="team"></div>

  <button class="button" onclick="backToLobby()">PowrÃ³t</button>
</div>

<!-- âœ… FUZJE -->
<div id="fusionScreen" class="screen">
  <h2>âš—ï¸ Fuzje Kart</h2>
  <p>PoÅ‚Ä…cz odpowiednie postacie, aby stworzyÄ‡ nowe!</p>
  <div id="fusionList"></div>
  <button class="button" onclick="backToLobby()">PowrÃ³t</button>
</div>

<!-- âœ… QUESTY -->
<div id="questScreen" class="screen">
  <h2>ğŸŸ  Zadania (Questy)</h2>
  <div id="questList"></div>
  <button class="button" onclick="backToLobby()">PowrÃ³t</button>
</div>

<!-- âœ… USTAWIENIA -->
<div id="settingsScreen" class="screen">
  <h2>Ustawienia</h2>

  <button class="button" onclick="resetGame()" style="background:#550000; border-color:red;">
    ğŸ”¥ RESETUJ CAÅÄ„ GRÄ˜
  </button>

  <p style="color:#ff5555; max-width:400px; margin:auto;">
    Uwaga! Reset usuwa wszystkie karty, druÅ¼ynÄ™, monety i postaÄ‡.  
    Tego nie da siÄ™ cofnÄ…Ä‡!
  </p>

  <button class="button" onclick="backToLobby()">PowrÃ³t</button>
</div>

<!-- âœ… SKLEP -->
<div id="shopScreen" class="screen">
  <h2>ğŸ›’ Sklep</h2>

  <div style="margin-bottom:20px;">
    <p>ğŸ’¼ <b>ZwykÅ‚a Paczka</b> â€“ 100 Coins</p>
    <p><small>54% Basic, 26% Rare, 15% Epic, 4% Legendary, 0.9% Mythic, 0.1% Eternal</small></p>
    <button class="button" onclick="buyPack()">Kup zwykÅ‚Ä… paczkÄ™</button>
  </div>

  <div style="margin-bottom:20px;">
    <p>ğŸŒŸ <b>Super Pack</b> â€“ 600 Coins</p>
    <p><small>50% Rare, 30% Epic, 15% Legendary, 4.5% Mythic, 0.5% Eternal</small></p>
    <button class="button" style="background:#224466;" onclick="buySuperPack()">Kup Super Pack</button>
  </div>

  <button class="button" onclick="backToLobby()">PowrÃ³t</button>
</div>

<!-- âœ… POJEDYNEK -->
<div id="battleScreen" class="screen">
  <h2>âš” Pojedynek âš”</h2>
  <div class="battleArea">
    <div id="playerSide"></div>
    <div id="enemySide"></div>
  </div>
  <h3 id="battleLog"></h3>

  <button class="button" onclick="backToLobby()">PowrÃ³t</button>
</div>

<script>

let player = {
  name: "",
  coins: 0,
  cards: [],
  team: []
};

const allCards = [
  { name: "Acronix", hp: 13, damage: 2, speed: 0.5, super: null, img: "Acronix.png", rarity: "Basic" },
  { name: "Alex", hp: 20, damage: 1, speed: 0.55, super: null, img: "Alex.png", rarity: "Basic" },
  { name: "Allay", hp: 10, damage: 1, speed: 0.3, super: null, img: "Allay.png", rarity: "Basic" },
  { name: "Bee", hp: 5, damage: 1, speed: 0.5, super: null, img: "Bee.png", rarity: "Basic" },
  { name: "Chicken Jockey", hp: 24, damage: 4, speed: 0.9, super: null, img: "Chicken Jockey.png", rarity: "Basic" },
  { name: "Freddy", hp: 30, damage: 6, speed: 1.3, super: null, img: "Freddy.png", rarity: "Basic" },
  { name: "Gulczykowa", hp: 10, damage: 4, speed: 0.9, super: null, img: "Gulczykowa.png", rarity: "Basic" },
  { name: "King", hp: 16, damage: 3, speed: 1.7, super: "AOE", img: "King.png", rarity: "Basic" },
  { name: "Luz", hp: 10, damage: 1, speed: 0.5, super: null, img: "Luz.png", rarity: "Basic" },
  { name: "Pink Sheep", hp: 10, damage: 3, speed: 0.9, super: null, img: "Pink Sheep.png", rarity: "Basic" },
  { name: "Posuch", hp: 20, damage: 3, speed: 0.95, super: null, img: "Posuch.png", rarity: "Basic" },
  { name: "Skeleton", hp: 20, damage: 5, speed: 1.0, super: null, img: "Skeleton.png", rarity: "Basic" },
  { name: "Snow Golem", hp: 4, damage: 1, speed: 0.7, super: null, img: "Snow Golem.png", rarity: "Basic" },
  { name: "Toy Bonnie", hp: 19, damage: 5, speed: 0.8, super: "AOE", img: "Toy Bonnie.png", rarity: "Basic" },
  { name: "Vanessa", hp: 10, damage: 2, speed: 0.4, super: null, img: "Vanessa.png", rarity: "Basic" },
  { name: "Wooly", hp: 12, damage: 2, speed: 0.75, super: null, img: "Wooly.png", rarity: "Basic" },
  { name: "Zombie", hp: 20, damage: 3, speed: 0.95, super: null, img: "Zombie.png", rarity: "Basic" },

  { name: "Albi", hp: 10, damage: 8, speed: 0.3, super: null, img: "Albi.png", rarity: "Rare" },
  { name: "Arctic Fox", hp: 18, damage: 4, speed: 1.0, super: null, img: "Arctic Fox.png", rarity: "Rare" },
  { name: "Baby Zombie", hp: 20, damage: 3, speed: 0.5, super: null, img: "Baby Zombie.png", rarity: "Rare" },
  { name: "Balloon Boy", hp: 20, damage: 8, speed: 1.65, super: "Splash", img: "Balloon Boy.png", rarity: "Rare" },
  { name: "Bonnie", hp: 30, damage: 6, speed: 1.0, super: "AOE", img: "Bonnie.png", rarity: "Rare" },
  { name: "Chica", hp: 30, damage: 9, speed: 2.0, super: "Splash", img: "Chica.png", rarity: "Rare" },
  { name: "Helpy", hp: 28, damage: 4, speed: 1.0, super: "AOE", img: "Helpy.png", rarity: "Rare" },
  { name: "Spider Jockey", hp: 36, damage: 9, speed: 1.1, super: null, img: "Spider Jockey.png", rarity: "Rare" },
  { name: "Spider Man", hp: 10, damage: 8, speed: 0.84, super: null, img: "Spider Man.png", rarity: "Rare" },
  { name: "Tv Man", hp: 20, damage: 5, speed: 0.8, super: "AOE", img: "Tv Man.png", rarity: "Rare" },
  { name: "Vaggie", hp: 22, damage: 8, speed: 1.5, super: null, img: "Vaggie.png", rarity: "Rare" },

  { name: "Afton", hp: 20, damage: 9, speed: 0.7, super: null, img: "Afton.png", rarity: "Epic" },
  { name: "Arin", hp: 10, damage: 20, speed: 2.0, super: "Splash", img: "Arin.png", rarity: "Epic" },
  { name: "Doey", hp: 42, damage: 8, speed: 1.5, super: "Splash", img: "Doey.png", rarity: "Epic" },
  { name: "Enderman", hp: 40, damage: 3, speed: 1.0, super: null, img: "Enderman.png", rarity: "Epic" },
  { name: "Foxy", hp: 30, damage: 7, speed: 0.7, super: null, img: "Foxy.png", rarity: "Epic" },
  { name: "Han Solo", hp: 20, damage: 8, speed: 0.8, super: null, img: "Han Solo.png", rarity: "Epic" },
  { name: "Hydreigon", hp: 30, damage: 3, speed: 0.8, super: "AOE", img: "Hydreigon.png", rarity: "Epic" },
  { name: "Nightmare Chica", hp: 45, damage: 18, speed: 3.0, super: "Splash", img: "Nightmare Chica.png", rarity: "Epic" },
  { name: "Marwowy", hp: 10, damage: 7, speed: 0.6, super: "Splash", img: "Marwowy.png", rarity: "Epic" },
  { name: "Sonic", hp: 14, damage: 7, speed: 0.3, super: null, img: "Sonic.png", rarity: "Epic" },
  { name: "The Knocer", hp: 20, damage: 12, speed: 0.85, super: null, img: "The Knocer.png", rarity: "Epic" },
  { name: "Titan Luz", hp: 20, damage: 8, speed: 0.7, super: null, img: "Titan Luz.png", rarity: "Epic" },

  { name: "Alastor", hp: 60, damage: 12, speed: 1.0, super: null, img: "Alastor.png", rarity: "Legendary" },
  { name: "Anomaly", hp: 50, damage: 2, speed: 0.3, super: "AOE", img: "Anomaly.png", rarity: "Legendary" },
  { name: "Colton Anomaly", hp: 50, damage: 14, speed: 1.0, super: null, img: "Colton Anomaly.png", rarity: "Legendary" },
  { name: "Darth Vader", hp: 25, damage: 10, speed: 0.85, super: null, img: "Darth Vader.png", rarity: "Legendary" },
  { name: "Huggy Wuggy", hp: 50, damage: 11, speed: 1.0, super: null, img: "Huggy Wuggy.png", rarity: "Legendary" },
  { name: "Large Astro TV Man", hp: 32, damage: 8, speed: 0.6, super: "AOE", img: "Tv Man.png", rarity: "Legendary" },
  { name: "Mimicer", hp: 50, damage: 14, speed: 1.0, super: null, img: "Mimicer.png", rarity: "Legendary" },
  { name: "Shadow", hp: 16, damage: 5, speed: 0.2, super: null, img: "Shadow.png", rarity: "Legendary" },
  { name: "Vox", hp: 60, damage: 7, speed: 0.75, super: "AOE", img: "Vox.png", rarity: "Legendary" },

  { name: "DJ Vox", hp: 67, damage: 8, speed: 0.6, super: "AOE", img: "DJ Vox.png", rarity: "Mythic" },
  { name: "R2 D2", hp: 46, damage: 1, speed: 0.15, super: "AOE", img: "R2 D2.png", rarity: "Mythic" },
  { name: "The Man From The Shadow", hp: 40, damage: 20, speed: 1.0, super: null, img: "The Man From The Shadow.png", rarity: "Mythic" },
  { name: "Warden", hp: 50, damage: 18, speed: 1.1, super: "Splash", img: "Warden.png", rarity: "Mythic" },
  { name: "Zestial", hp: 60, damage: 15, speed: 1.0, super: null, img: "Zestial.png", rarity: "Mythic" },

  { name: "H4CK3R", hp: 10, damage: 5, speed: 0.2, super: "AOE", img: "H4CK3R.png", rarity: "Eternal" },
  { name: "Thanos", hp: 46, damage: 13, speed: 1.3, super: "Splash", img: "Thanos.png", rarity: "Eternal" },
  { name: "The Deer", hp: 50, damage: 10, speed: 0.6, super: null, img: "The Deer.png", rarity: "Eternal" },

  { name: "Bekin", hp: 21, damage: 2, speed: 1.2, super: "AOE", img: "Bekin.png", rarity: "Exclusive" },
  { name: "Zombox", hp: 80, damage: 10, speed: 0.2, super: "AOE", img: "Zombox.png", rarity: "Exclusive" }
];

// === ğŸ§ª DOSTÄ˜PNE FUZJE ===
const fusions = [
  {
    id: 1,
    base1: "Vox",
    base2: "Zombie",
    result: { name: "Zombox", hp: 80, damage: 10, speed: 0.2, super: "AOE", img: "Zombox.png", rarity: "Exclusive" }
  },
  {
    id: 2,
    base1: "Bee",
    base2: "King",
    result: { name: "Bekin", hp: 21, damage: 2, speed: 1.2, super: "AOE", img: "Bekin.png", rarity: "Exclusive" }
  },
];

function saveGame() {
  const saveData = {
    name: player.name,
    coins: player.coins,
    cards: player.cards,
    team: player.team.map(c => c.name),
    quests: quests.map(q => ({
      id: q.id,
      progress: q.progress,
      completed: q.completed
    }))
  };
  localStorage.setItem("save", JSON.stringify(saveData));
}

function loadGame() {
  const data = localStorage.getItem("save");
  if (!data) return;

  const save = JSON.parse(data);

  player.name = save.name;
  player.coins = save.coins;
  player.cards = save.cards || [];

  player.team = (save.team || [])
    .filter(name => allCards.some(c => c.name === name))
    .map(name => {
      const c = allCards.find(x => x.name === name);
      return { ...c };
    });

  if (save.quests && Array.isArray(save.quests)) {
    save.quests.forEach(savedQ => {
      const q = quests.find(q => q.id === savedQ.id);
      if (q) {
        q.progress = savedQ.progress;
        q.completed = savedQ.completed;
      }
    });
  }

  document.getElementById("nameDisplay").textContent = player.name;
  document.getElementById("coinsDisplay").textContent = player.coins;

  renderInventory();
  renderTeam();

  // JeÅ›li gracz ma questy â€” odÅ›wieÅ¼ ekran questÃ³w po wczytaniu
  if (document.getElementById("questList")) {
    renderQuests();
  }
}

function enterFusion() {
  switchScreen("lobbyScreen", "fusionScreen");
  renderFusions();
}

function renderFusions() {
  const div = document.getElementById("fusionList");
  div.innerHTML = "";

  fusions.forEach(f => {
    const have1 = player.cards.some(c => c.name === f.base1 && c.count > 0);
    const have2 = player.cards.some(c => c.name === f.base2 && c.count > 0);

    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <strong>${f.base1} + ${f.base2}</strong><br>
      = <b style="color:#00ff88;">${f.result.name}</b><br>
      ${have1 && have2 ? "<button class='button' onclick='doFusion(" + f.id + ")'>PoÅ‚Ä…cz</button>" : "<span style='color:#888;'>Brak wymaganych kart</span>"}
    `;
    div.appendChild(el);
  });
}

function doFusion(id) {
  const f = fusions.find(x => x.id === id);
  if (!f) return;

  const have1 = player.cards.find(c => c.name === f.base1);
  const have2 = player.cards.find(c => c.name === f.base2);

  if (!have1 || !have2 || have1.count <= 0 || have2.count <= 0) {
    alert("Nie masz wymaganych kart!");
    return;
  }

  // usuÅ„ po 1 sztuce kaÅ¼dej z kart
  have1.count--;
  have2.count--;

  // dodaj nowÄ… kartÄ™
  let existing = player.cards.find(c => c.name === f.result.name);
  if (existing) existing.count++;
  else {
    player.cards.push({ ...f.result, count: 1 });
    // jeÅ›li chcesz, moÅ¼esz teÅ¼ dodaÄ‡ nowÄ… kartÄ™ do allCards, jeÅ›li chcesz mieÄ‡ jej peÅ‚ne dane w grze:
    if (!allCards.some(c => c.name === f.result.name)) {
      allCards.push(f.result);
    }
  }

  alert(`âš—ï¸ PowstaÅ‚a nowa karta: ${f.result.name}!`);
  renderInventory();
  renderFusions();
  saveGame();
}

// === ğŸŸ  QUESTY ===
const quests = [
  {
    id: 1,
    title: "Wygraj 10 walk",
    goal: 10,
    progress: 0,
    reward: { type: "coins", amount: 200 },
    completed: false
  },
  {
    id: 2,
    title: "Kup 3 paczki kart",
    goal: 3,
    progress: 0,
    reward: { type: "exclusiveCard", card: "Spider Man" },
    completed: false
  },
  {
    id: 3,
    title: "Kup 25 paczki kart",
    goal: 25,
    progress: 0,
    reward: { type: "exclusiveCard", card: "Thanos" },
    completed: false
  }
];

function enterQuests() {
  switchScreen("lobbyScreen", "questScreen");
  renderQuests();
}

function renderQuests() {
  const div = document.getElementById("questList");
  div.innerHTML = "";

  quests.forEach(q => {
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <h3>${q.title}</h3>
      <p>PostÄ™p: ${q.progress}/${q.goal}</p>
      <p>Nagroda: ${
        q.reward.type === "coins"
          ? `${q.reward.amount} ğŸ’°`
          : `ğŸ´ ${q.reward.card}`
      }</p>
      ${q.completed ? "<b style='color:#00ff88;'>âœ” UkoÅ„czono!</b>" : ""}
    `;

    if (!q.completed && q.progress >= q.goal) {
      const btn = document.createElement("button");
      btn.className = "button";
      btn.textContent = "Odbierz nagrodÄ™";
      btn.onclick = () => claimQuestReward(q.id);
      el.appendChild(btn);
    }

    div.appendChild(el);
  });
}

function claimQuestReward(id) {
  const q = quests.find(x => x.id === id);
  if (!q || q.completed) return;

  if (q.reward.type === "coins") {
    player.coins += q.reward.amount;
    alert(`ğŸ’° Otrzymano ${q.reward.amount} coins!`);
  } else if (q.reward.type === "exclusiveCard") {
    const card = allCards.find(c => c.name === q.reward.card);
    if (card) {
      let existing = player.cards.find(c => c.name === card.name);
      if (existing) existing.count++;
      else player.cards.push({ ...card, count: 1 });
      alert(`ğŸ´ Otrzymano kartÄ™ Exclusive: ${card.name}!`);
    }
  }

  q.completed = true;
  saveGame();
  renderQuests();
}

// === Aktualizacja postÄ™pu questÃ³w ===
function updateQuestProgress(type) {
  quests.forEach(q => {
    if (q.completed) return;

    if (type === "winBattle" && q.title.includes("Wygraj")) {
      q.progress++;
    }
    if (type === "buyPack" && q.title.includes("Kup")) {
      q.progress++;
    }
    if (type === "collectCard" && q.title.includes("Zbierz")) {
      q.progress = player.cards.length;
    }
  });
  saveGame();
}

function getRandomRarity() {
  const r = Math.random() * 100;

  if (r < 54) return "Basic";        
  if (r < 80) return "Rare";        
  if (r < 95) return "Epic";       
  if (r < 99) return "Legendary";  
  if (r < 99.9) return "Mythic";      
  return "Eternal";                    
}

function getSuperRarity() {
  const r = Math.random() * 100;
  if (r < 50) return "Rare";
  if (r < 80) return "Epic";
  if (r < 95) return "Legendary";
  if (r < 99.5) return "Mythic";
  return "Eternal";
}

function startClassicBattle() {
  switchScreen("battleModeScreen", "battleScreen");
  startBattle(); // twoja stara funkcja walki
}

function getRandomCard() {
  const rarity = getRandomRarity();
  const pool = allCards.filter(c => c.rarity === rarity);
  const card = pool[Math.floor(Math.random() * pool.length)];

  let existing = player.cards.find(c => c.name === card.name);
  if (existing) existing.count++;
  else player.cards.push({ ...card, count: 1 });

  alert(`ğŸ´ Wylosowano (${rarity}): ${card.name}`);
  renderInventory();
}

/* âœ… TWORZENIE POSTACI */
function createPlayer() {
  let name = document.getElementById("playerName").value.trim();
  if (!name) return alert("Wpisz nazwÄ™!");
  player.name = name;
  player.coins = 100;
  document.getElementById("nameDisplay").textContent = name;
  document.getElementById("coinsDisplay").textContent = player.coins;
  switchScreen("createScreen", "lobbyScreen");
  saveGame();
}

function switchScreen(hide, show) {
  document.getElementById(hide).classList.remove("active");
  document.getElementById(show).classList.add("active");
}

function backToLobby() {
  document.getElementById("coinsDisplay").textContent = player.coins;
  switchScreen(
    document.querySelector(".screen.active").id,
    "lobbyScreen"
  );
}

function enterSettings() {
  switchScreen("lobbyScreen", "settingsScreen");
}

function resetGame() {
  if (!confirm("Czy na pewno chcesz zresetowaÄ‡ CAÅÄ„ grÄ™?")) return;

  // usuÅ„ zapis
  localStorage.removeItem("save");

  // wyczyÅ›Ä‡ obiekt gracza
  player = {
    name: "",
    coins: 0,
    cards: [],
    team: []
  };

  // wrÃ³Ä‡ do ekranu tworzenia postaci
  switchScreen(
    document.querySelector(".screen.active").id,
    "createScreen"
  );

  alert("âœ… Gra zostaÅ‚a zresetowana!");
}

function goInventory() {
  renderInventory();
  renderTeam();
  switchScreen("lobbyScreen", "inventoryScreen");
}

function renderInventory() {
  let div = document.getElementById("inventory");
  div.innerHTML = "";

  player.cards.forEach(card => {
    const base = allCards.find(c => c.name === card.name);
    if (!base) return;

    const sellValue = getSellValue(base.rarity);

    let el = document.createElement("div");
    el.className = "card";
    el.setAttribute("data-rarity", base.rarity);
    el.innerHTML = `
      <img src="${base.img}">
      <strong>${base.name}</strong><br>
      Rarity: ${base.rarity}<br>
      â¤ï¸ ${base.hp} DMG ${base.damage}<br>
      Speed: ${base.speed}s<br>
      Super: ${base.super || "Brak"}<br>
      IloÅ›Ä‡: ${card.count}<br>
      <button class='button' onclick="addToTeam('${base.name}')">Dodaj do druÅ¼yny</button>
      <button class='button' style="background:#552222; border-color:red;" onclick="sellCard('${base.name}')">ğŸ’° Sprzedaj (${sellValue}c)</button>
    `;
    div.appendChild(el);
  });
}

function getSellValue(rarity) {
  switch (rarity) {
    case "Basic": return 5;
    case "Rare": return 12;
    case "Epic": return 25;
    case "Legendary": return 40;
    case "Mythic": return 70;
    case "Eternal": return 100;
    case "Exclusive": return 150; // jeÅ›li dodano nowÄ… rarowoÅ›Ä‡
    default: return 0;
  }
}

function sellCard(name) {
  const card = player.cards.find(c => c.name === name);
  if (!card) return;

  const base = allCards.find(c => c.name === name);
  const sellValue = getSellValue(base.rarity);

  if (!confirm(`Czy chcesz sprzedaÄ‡ 1x ${name} za ${sellValue} coins?`)) return;

  // usuÅ„ 1 sztukÄ™
  card.count--;
  if (card.count <= 0) {
    player.cards = player.cards.filter(c => c.name !== name);
    // usuÅ„ z druÅ¼yny jeÅ›li byÅ‚a
    player.team = player.team.filter(t => t !== name);
  }

  player.coins += sellValue;

  alert(`ğŸ’° Sprzedano ${name} za ${sellValue} coins!`);
  document.getElementById("coinsDisplay").textContent = player.coins;

  saveGame();
  renderInventory();
  renderTeam();
}

function removeFromTeam(name) {
  const index = player.team.indexOf(name);
  if (index !== -1) {
    player.team.splice(index, 1);
    saveGame();
    renderTeam();
  }
}

function addToTeam(name) {
  if (player.team.length >= 3) return alert("Masz juÅ¼ 3 karty!");

  let c = player.cards.find(x => x.name === name);
  if (!c) return;

  // sprawdzenie ile razy dana karta juÅ¼ jest w druÅ¼ynie
  const inTeamCount = player.team.filter(x => x === name).length;
  if (inTeamCount >= c.count) {
    return alert(`Nie masz wiÄ™cej sztuk ${c.name} do dodania!`);
  }

  player.team.push(c.name);
  saveGame();
  renderTeam();
}

function renderTeam() {
  const t = document.getElementById("team");
  t.innerHTML = "";

  player.team.forEach(name => {
    const c = allCards.find(x => x.name === name);
    if (!c) return;

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <h3>${c.name}</h3>
      <p>Atak: ${c.damage}</p>
      <p>Å»ycie: ${c.hp}</p>
      <p>Speed: ${c.speed}s</p>
      <p>Super: ${c.super || "Brak"}</p>
      <p>RzadkoÅ›Ä‡: ${c.rarity}</p>
      <button onclick="removeFromTeam('${c.name}')">UsuÅ„</button>
    `;
    t.appendChild(div);
  });
}

function enterShop() {
  switchScreen("lobbyScreen", "shopScreen");
}

function buyPack() {
  if (player.coins >= 100) {
    player.coins -= 100;
    document.getElementById("coinsDisplay").textContent = player.coins; // poprawnie
    getRandomCard();
    updateQuestProgress("buyPack");
    updateQuestProgress("collectCard");
    saveGame();
  } else {
    alert("Masz za maÅ‚o Coins!");
  }
}

function buySuperPack() {
  if (player.coins >= 600) {
    player.coins -= 600;
    document.getElementById("coinsDisplay").textContent = player.coins;

    const rarity = getSuperRarity();
    const pool = allCards.filter(c => c.rarity === rarity);
    const card = pool[Math.floor(Math.random() * pool.length)];

    let existing = player.cards.find(c => c.name === card.name);
    if (existing) existing.count++;
    else player.cards.push({ ...card, count: 1 });

    alert(`ğŸ OtworzyÅ‚eÅ› Super Pack!\nWylosowano (${rarity}): ${card.name}`);
    updateQuestProgress("buyPack");
    updateQuestProgress("collectCard");
    renderInventory();
    saveGame();
  } else {
    alert("Masz za maÅ‚o Coins!");
  }
}

let battleRunning = false;

function enterBattle() {
  if (player.team.length === 0) return alert("Wybierz druÅ¼ynÄ™!");
  switchScreen("lobbyScreen", "battleScreen");

  const pSide = document.getElementById("playerSide");
  const eSide = document.getElementById("enemySide");
  pSide.innerHTML = "";
  eSide.innerHTML = "";
  document.getElementById("battleLog").textContent = "";

  // Tworzymy jednostki gracza
  playerUnits = player.team.map(name => {
    const card = allCards.find(c => c.name === name);
    const el = createBattleCard(card);
    pSide.appendChild(el);
    return { team: "player", card: { ...card, currentHP: card.hp }, element: el, target: null };
  });

  // Tworzymy jednostki przeciwnika
  enemyUnits = [];
  for (let i = 0; i < player.team.length; i++) {
    const c = allCards[Math.floor(Math.random() * allCards.length)];
    const el = createBattleCard(c);
    eSide.appendChild(el);
    enemyUnits.push({ team: "enemy", card: { ...c, currentHP: c.hp }, element: el });
  }

  // Dodajemy wybÃ³r celu dla kaÅ¼dej jednostki gracza
  playerUnits.forEach((unit, idx) => {
    const select = document.createElement("select");
    select.innerHTML = enemyUnits.map((enemy, eidx) => `<option value="${eidx}">${enemy.card.name}</option>`).join("");
    unit.element.appendChild(document.createElement("br"));
    unit.element.appendChild(select);
    unit.targetSelector = select; // zapamiÄ™tujemy selector
  });

  // Dodaj przycisk rozpoczÄ™cia walki
  const startBtn = document.createElement("button");
  startBtn.textContent = "Rozpocznij walkÄ™";
  startBtn.className = "button";
  startBtn.onclick = () => {
    // ustawienie wybranych celÃ³w
    playerUnits.forEach(unit => {
      const targetIdx = parseInt(unit.targetSelector.value);
      unit.target = enemyUnits[targetIdx];
      // usuwamy selector po zatwierdzeniu
      unit.element.removeChild(unit.targetSelector.previousSibling); // <br>
      unit.element.removeChild(unit.targetSelector);
    });
    startBtn.remove(); // usuÅ„ przycisk po zatwierdzeniu
    battleRunning = true;
    playerUnits.forEach(u => autoAttack(u, enemyUnits));
    enemyUnits.forEach(u => autoAttack(u, playerUnits));
  };
  pSide.appendChild(startBtn);
}


function checkPlayerDefeat() {
  // jeÅ›li wszystkie karty gracza majÄ… 0 HP â†’ przegrana
  if (alive(playerUnits).length === 0) {
    battleRunning = false;
    document.getElementById("battleLog").textContent = "âŒ PrzegraÅ‚eÅ›!";
    return true;
  }
  return false;
}

function alive(arr) {
  return arr.filter(x => x.card.currentHP > 0);
}

async function attack(attacker, enemies) {
  const targets = alive(enemies);
  if (!targets.length) return;

  /* SUPER AOE */
  if (attacker.card.super === "AOE") {
    targets.forEach(t => {
      t.card.currentHP -= attacker.card.damage;
      if (t.card.currentHP < 0) t.card.currentHP = 0;
      t.element.classList.add("hit");
      setTimeout(() => t.element.classList.remove("hit"), 200);
    });
  }

  /* SUPER SPLASH */
  else if (attacker.card.super === "Splash") {
    const main = targets[Math.floor(Math.random() * targets.length)];

    main.card.currentHP -= attacker.card.damage;
    if (main.card.currentHP < 0) main.card.currentHP = 0;

    main.element.classList.add("hit");
    setTimeout(() => main.element.classList.remove("hit"), 200);

    targets.forEach(t => {
      if (t !== main) {
        t.card.currentHP -= Math.floor(attacker.card.damage / 2);
        if (t.card.currentHP < 0) t.card.currentHP = 0;

        t.element.classList.add("hit");
        setTimeout(() => t.element.classList.remove("hit"), 200);
      }
    });
  }

  /* NORMALNY ATAK */
  else {
    const target = targets[Math.floor(Math.random() * targets.length)];
    target.card.currentHP -= attacker.card.damage;
    if (target.card.currentHP < 0) target.card.currentHP = 0;

    target.element.classList.add("hit");
    setTimeout(() => target.element.classList.remove("hit"), 200);
  }

  updateHPBars();

  // âœ… AUTO PRZEGRANA GRACZA
  if (attacker.team === "enemy") {
    if (checkPlayerDefeat()) return;
  }
}

function createBattleCard(card) {
  const div = document.createElement("div");
  div.className = "card";
  div.innerHTML = `
    <img src="${card.img}">
    <strong>${card.name}</strong><br>
    <div class="hp-bar-bg"><div class="hp-bar"></div></div>
  `;
  return div;
}

function updateHPBars() {

  // aktualizacja paskÃ³w HP
  [...playerUnits, ...enemyUnits].forEach(u => {
    const bar = u.element.querySelector(".hp-bar");
    const percent = Math.max(0, (u.card.currentHP / u.card.hp) * 100);
    bar.style.width = percent + "%";

    // opcjonalnie: zmiana koloru przy niskim HP
    if (percent <= 30) bar.style.background = "#ff3333";
    else bar.style.background = "#00ff88";
  });
}

let playerUnits = [];
let enemyUnits = [];

async function startBattle() {
  const pSide = document.getElementById("playerSide");
  const eSide = document.getElementById("enemySide");
  pSide.innerHTML = "";
  eSide.innerHTML = "";
  document.getElementById("battleLog").textContent = "";

  playerUnits = player.team.map(name => {
    const card = allCards.find(c => c.name === name);
    const el = createBattleCard(card);
    pSide.appendChild(el);
    return { team: "player", card: { ...card, currentHP: card.hp }, element: el };
  });

  enemyUnits = [];
  for (let i = 0; i < player.team.length; i++) {
    const c = allCards[Math.floor(Math.random() * allCards.length)];
    const el = createBattleCard(c);
    eSide.appendChild(el);
    enemyUnits.push({ team: "enemy", card: { ...c, currentHP: c.hp }, element: el });
  }

  battleRunning = true;

  playerUnits.forEach(u => autoAttack(u, enemyUnits));
  enemyUnits.forEach(u => autoAttack(u, playerUnits));
}

async function autoAttack(unit, enemies) {
  while (battleRunning && unit.card.currentHP > 0 && alive(enemies).length > 0) {
    await new Promise(res => setTimeout(res, unit.card.speed * 1000));

    if (!battleRunning || unit.card.currentHP <= 0) break;

    attack(unit, enemies);

    // âœ… JeÅ›li druÅ¼yna przeciwnika zginÄ™Å‚a â€” koniec
    if (alive(enemies).length === 0) {
      battleRunning = false;

      if (unit.team === "player") {
        player.coins += 10;
        document.getElementById("coinsDisplay").textContent = player.coins;
        updateQuestProgress("winBattle");
        saveGame();
      }

      return;
    }

    // âœ… JeÅ›li wszystkie karty gracza majÄ… 0 HP â†’ przegrana
    if (checkPlayerDefeat()) return;
  }
}
window.onload = () => {
  loadGame();

  const data = localStorage.getItem("save");
  if (data) {
    switchScreen("createScreen", "lobbyScreen");
  }
};

</script>

</body>
</html>